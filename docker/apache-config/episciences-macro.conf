<Macro EpiHost $environment $journal-code $domain_suffix>
<VirtualHost *:80>
    ServerName $journal-code.$domain_suffix
    ServerAlias localhost 127.0.0.1

    # ==============================================================================
    # REVERSE PROXY CONFIGURATION (Next.js Node.js Server)
    # ==============================================================================
    
    # 1. Preserve the original Host header so Next.js Middleware can detect the tenant
    ProxyPreserveHost On

    # 2. Define the upstream Node.js server (container name or IP)
    # In a docker-compose setup, 'app' is usually the service name of the Next.js container
    Define upstream_server http://app:3000

    # ==============================================================================
    # LEGACY ASSETS & FILESYSTEM (Served directly by Apache)
    # ==============================================================================
    
    # RemoteIP configuration (adapted for Docker network)
    RemoteIPHeader X-Forwarded-For
    RemoteIPInternalProxy 172.16.0.0/12

    # Direct access to mock data directories (simulating production NFS mounts)
    # These bypass Node.js for performance and legacy compatibility
    Alias /sitemap.xml "/data/epi/$environment/$journal-code/sitemap/sitemap.xml"
    Alias /public/documents/ "/data/epi/$environment/$journal-code/public/documents/"
    Alias /volumes-full/ "/data/epi/$environment/$journal-code/public/volume-pdf/"
    Alias /volumes-doaj/ "/data/epi/$environment/$journal-code/public/volume-doaj/"
    Alias /public/volumes/ "/data/epi/$environment/$journal-code/public/volumes/"
    
    # User profile pictures
    Alias /user/picture/ "/data/user_photo/$environment/uuid/"
    
    # General resources fallback
    Alias /$journal-code/resources/ "/data/epi/$environment/$journal-code/public/"

    # Security: Block access to sensitive file types
    RedirectMatch 404 \.md$
    RedirectMatch 404 \.sql$
    RedirectMatch 404 \.sh$
    RedirectMatch 404 \.git$
    RedirectMatch 404 \~$
    RedirectMatch 404 \.back$
    RedirectMatch 404 \.save$
    RedirectMatch 404 \.tar$
    RedirectMatch 404 \.bz2$
    RedirectMatch 404 \.rar$

    # ==============================================================================
    # PERMISSIONS
    # ==============================================================================

    <Directory "/data/user_photo/$environment/uuid">
        Options -Indexes
        Require all granted
    </Directory>
    <Directory "/data/epi/$environment/$journal-code">
        Options -Indexes
        Require all granted
    </Directory>
    <Directory "/data/epi/$environment/$journal-code/public/volume-pdf/">
        Options -Indexes
        Require all granted
    </Directory>

    # ==============================================================================
    # PROXY RULES (Everything else goes to Next.js)
    # ==============================================================================

    # Bypass Proxy for the Aliases defined above
    ProxyPass /sitemap.xml !
    ProxyPass /public/documents/ !
    ProxyPass /volumes-full/ !
    ProxyPass /volumes-doaj/ !
    ProxyPass /public/volumes/ !
    ProxyPass /user/picture/ !
    ProxyPass /$journal-code/resources/ !

    # Forward everything else to Next.js
    ProxyPass / ${upstream_server}/
    ProxyPassReverse / ${upstream_server}/

    # ==============================================================================
    # SECURITY HEADERS
    # ==============================================================================
    
    <IfModule mod_headers.c>
        # Headers are also handled by Next.js, but Apache can enforce them at the edge
        Header set X-Content-Type-Options "nosniff"
        Header always set Referrer-Policy "no-referrer-when-downgrade"
    </IfModule>

</VirtualHost>
</Macro>