<Macro EpiHost $environment $journal-code>
<VirtualHost *:80>
    ServerName $journal-code.episciences.test
    ServerAlias localhost 127.0.0.1

    Define app_path /sites/episciences-front/dist/$journal-code
    Define manager manager.episciences.org
    ServerAdmin ccsd-tech@ccsd.cnrs.fr
    DocumentRoot ${app_path}

    # RemoteIP configuration (adapted for Docker network)
    RemoteIPHeader X-Forwarded-For
    RemoteIPInternalProxy 172.16.0.0/12

    # Alias to mock data directories (simulating production paths)
    Alias /sitemap.xml "/data/epi/$environment/$journal-code/sitemap/sitemap.xml"
    Alias /public/documents/ "/data/epi/$environment/$journal-code/public/documents/"
    Alias /volumes-full/ "/data/epi/$environment/$journal-code/public/volume-pdf/"
    Alias /volumes-doaj/ "/data/epi/$environment/$journal-code/public/volume-doaj/"
    Alias /public/volumes/ "/data/epi/$environment/$journal-code/public/volumes/"
    Alias /icons "${app_path}/icons"
    Alias /logos "${app_path}/logos"
    Alias /user/picture/ "/data/user_photo/$environment/uuid/"
    Alias /$journal-code/resources/ "/data/epi/$environment/$journal-code/public/"

    # Security: Block access to sensitive file types
    RedirectMatch 404 \.md$
    RedirectMatch 404 \.sql$
    RedirectMatch 404 \.sh$
    RedirectMatch 404 \.git$
    RedirectMatch 404 \~$
    RedirectMatch 404 \.back$
    RedirectMatch 404 \.save$
    RedirectMatch 404 \.tar$
    RedirectMatch 404 \.bz2$
    RedirectMatch 404 \.rar$

    # Cache configuration (mod_expires)
    <IfModule mod_expires.c>
        ExpiresActive on
        AddType font/woff .woff
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 month"
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType application/x-javascript "access plus 1 year"
        ExpiresByType application/x-icon "access plus 1 month"
    </IfModule>

    # Permissions for data directories
    <Directory "/data/user_photo/$environment/uuid">
        Options -Indexes
        Require all granted
    </Directory>
    <Directory "/data/epi/$environment/$journal-code">
        Options -Indexes
        Require all granted
    </Directory>
    <Directory "/data/epi/$environment/$journal-code/public/volume-pdf/">
        Options -Indexes
        Require all granted
    </Directory>

    # Security headers (identical to production)
    <IfModule mod_headers.c>
        SetEnvIf Request_URI "\.html$" is_html
        Header set Link "<https://inbox.episciences.org/>; rel=\"http://www.w3.org/ns/ldp#inbox\"" env=is_html
        Header set X-Content-Type-Options "nosniff"
        Header always set Referrer-Policy "no-referrer-when-downgrade"
        Header Set Content-Security-Policy "default-src 'self'; font-src 'self' data: https://cdnjs.cloudflare.com/ajax/libs/mathjax/; img-src 'self' data: https://cdnjs.cloudflare.com/ajax/libs/mathjax/ https://archive.softwareheritage.org/badge/; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com/ajax/libs/mathjax/ https://piwik-episciences.ccsd.cnrs.fr/matomo.js; style-src 'self' 'unsafe-inline'; frame-src 'self' https://hal.science/ https://arxiv.org/ https://zenodo.org/ https://archive.softwareheritage.org/; connect-src 'self' https://www.zotero.org/styles/modern-language-association https://api.episciences.org/; manifest-src 'self'; object-src 'none'; worker-src 'none'; frame-ancestors 'none';"
    </IfModule>

    # Application directory configuration
    <Directory "${app_path}">
        # Redirections from old URLs to new routes
        RedirectPermanent /browse/latest https://$journal-code.episciences.org/articles
        RedirectPermanent /browse/accepted-docs https://$journal-code.episciences.org/articles-accepted
        RedirectPermanent /browse/volumes https://$journal-code.episciences.org/volumes
        RedirectPermanent /browse/section https://$journal-code.episciences.org/sections
        RedirectPermanent /page/about https://$journal-code.episciences.org/about
        RedirectPermanent /user/login https://${manager}.episciences.org/$journal-code/user/login
        RedirectPermanent /user/logout https://${manager}.episciences.org/$journal-code/user/login
        RedirectPermanent /user/create https://${manager}.episciences.org/$journal-code/user/create
        RedirectPermanent /user/lostlogin https://${manager}.episciences.org/$journal-code/user/lostlogin
        RedirectPermanent /user/lostpassword https://${manager}.episciences.org/$journal-code/user/lostpassword
        RedirectPermanent /user/permissions https://${manager}.episciences.org/$journal-code/user/permissions

        RewriteEngine On
        RewriteBase /

        # Remove trailing slashes (except root)
        RewriteCond %{REQUEST_URI} !^/$
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)/$ /$1 [R=301,L]

        # Custom redirects for old article URLs
        RewriteRule ^([0-9]+)$ https://$journal-code.episciences.org/articles/$1 [R=301,L]
        RewriteRule ^([0-9]+)/pdf$ https://$journal-code.episciences.org/articles/$1/download [R=301,L]
        RewriteRule ^volume/view/id/([0-9]+)$ https://$journal-code.episciences.org/volumes/$1 [R=301,L]
        RewriteRule ^section/view/id/([0-9]+)$ https://$journal-code.episciences.org/sections/$1 [R=301,L]

        # Bypass for direct file access (volume PDFs)
        RewriteCond %{REQUEST_URI} !^/volumes/.*\.(pdf)$ [NC]

        # Note: The old React fallback to index.html is commented out
        # Language detection is now handled by .htaccess generated during build
        # RewriteCond %{REQUEST_FILENAME} !-f
        # RewriteCond %{REQUEST_FILENAME} !-d
        # RewriteCond %{REQUEST_FILENAME} !-l
        # RewriteRule ^.*$ /index.html [L]

        # IMPORTANT: AllowOverride enables the generated .htaccess for language detection
        AllowOverride FileInfo
        Options -Indexes
        Require all granted
    </Directory>
</VirtualHost>
</Macro>
