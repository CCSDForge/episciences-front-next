# /etc/apache2/conf-available/episciences-macro.conf

<IfModule !macro_module>
    LoadModule macro_module modules/mod_macro.so
</IfModule>

# This macro configures a VirtualHost for a specific journal.
# $environment: 'prod' or 'production' (used for NFS paths)
# $journal-code: internal journal identifier (e.g., 'epijinfo')
# $domain_suffix: the domain name (e.g., 'episciences.org')
<Macro EpiHost $environment $journal-code $domain_suffix>
<VirtualHost *:80>
    ServerName $journal-code.$domain_suffix

    # 1. HAProxy SSL Termination Support
    # HAProxy handles SSL and sends X-Forwarded-Proto: https
    # Next.js and Apache need to trust/preserve these headers.
    ProxyPreserveHost On
    
    <IfModule mod_remoteip.c>
        RemoteIPHeader X-Forwarded-For
        # Add your HAProxy appliance IP or internal network range here
        # RemoteIPInternalProxy 10.0.0.0/8
    </IfModule>

    # 2. Legacy Assets & Filesystem (NFS Mounts)
    # Direct access to large files bypasses Node.js for better performance.
    Alias /sitemap.xml "/data/epi/$environment/$journal-code/sitemap/sitemap.xml"
    Alias /public/documents/ "/data/epi/$environment/$journal-code/public/documents/"
    Alias /volumes-full/ "/data/epi/$environment/$journal-code/public/volume-pdf/"
    Alias /volumes-doaj/ "/data/epi/$environment/$journal-code/public/volume-doaj/"
    Alias /public/volumes/ "/data/epi/$environment/$journal-code/public/volumes/"
    
    # User profile pictures
    Alias /user/picture/ "/data/user_photo/$environment/uuid/"

    # Security: Block access to sensitive file extensions
    RedirectMatch 404 \.(md|sql|sh|git|bak|save|tar|gz|bz2|rar)$

    <Directory "/data/epi/$environment/$journal-code">
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>

    <Directory "/data/user_photo/$environment/uuid">
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>

    # 3. Proxy Rules
    # Do not proxy requests that match the Aliases above
    ProxyPass /sitemap.xml !
    ProxyPass /public/documents/ !
    ProxyPass /volumes-full/ !
    ProxyPass /volumes-doaj/ !
    ProxyPass /public/volumes/ !
    ProxyPass /user/picture/ !

    # Forward all other requests to local Next.js server (Port 3000)
    ProxyPass / http://127.0.0.1:3000/
    ProxyPassReverse / http://127.0.0.1:3000/

    # 4. Security Headers
    <IfModule mod_headers.c>
        Header set X-Content-Type-Options "nosniff"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
    </IfModule>

    ErrorLog ${APACHE_LOG_DIR}/$journal-code-error.log
    CustomLog ${APACHE_LOG_DIR}/$journal-code-access.log combined
</VirtualHost>
</Macro>